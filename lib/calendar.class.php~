<?php
	define("END_OF_BOOKING_HOUR", 14, false);
	define("END_OF_BOOKING_MIN", 30, false);
	/**
	 * calendar class
	 * it use css class to operate with monthly or weekly rendering
	 */
	class calendar {
		private $handler;
		private $current_day; // this points to month should be shown and highlights day
		private $week_number;
		private $week_start;
		private $week_end;
		private $last_week;
		private $next_week;
		private $last_month;
		private $next_month;
		private $today;
		private $now;
		private $endOfTodaysBooking;
		private $interval;
		private $daterange;
		private $lang;
		
		private $week_nav;
		private $month_nav;		
		private $mobile_html; // HTML code of calendar to render it
		private $web_html; // HTML code of calendar to render it
		
		public function __construct($current_day, $lang) {
			require_once("timeslotshandler.class.php");
			$this->handler = new timeSlotsHandler();

			$this->current_day = new DateTime($current_day);
			$this->lang = $lang;			
			
			$this->getWeekParameters();
			$this->weekNav();
			
			$this->getMonthParameters();
			$this->monthNav();

			$this->week_end->modify("+1 day");
			$this->interval = new DateInterval('P1D');
			$this->daterange = new DatePeriod($this->week_start, $this->interval ,$this->week_end);
			
			$this->createMobileCalendar();
			//$this->createTabletCalendar();
			$this->createWebCalendar();
		}
		
		private function createMobileCalendar() {
			$this->mobile_html = '<div class="calendar">';
			$this->mobile_html .= $this->week_nav;
			foreach($this->daterange as $date) {
				if($date->format("j") == "1") {
					$this->mobile_html .= '<div class="calendar-month-header">';
					$this->mobile_html .= $date->format("F");
					$this->mobile_html .= '</div>';
				}
				$this->mobile_html .= '<div class="calendar-day-header'. ($this->isToday($date) ? ' today' : '').'">';
				$this->mobile_html .= '<div class="calendar-day-number">';
				$this->mobile_html .= $date->format("j");
				$this->mobile_html .= '</div>';
				$this->mobile_html .= '<div class="calendar-day-description">';
				$this->mobile_html .= $date->format("D");
				$this->mobile_html .= '</div>';
				$this->mobile_html .= '</div>';
				$this->mobile_html .= '<div class="calendar-day-content">';

				if ($this->validDate($date)) {
					$timeSlots = $this->handler->get($date->format("Y-m-d"));
				}
				if(isset($timeSlots) && !empty($timeSlots)) {
					if(!$this->isToday($date) || $this->allowTodayBooking()) {
						foreach ($timeSlots as $key => $timeSlot) {
							$this->mobile_html .= '<div class="calendar-time-slot">';
							$this->mobile_html .= '<a href="booking_form.php?test='.$key.'" class="time">';
							$this->mobile_html .= $timeSlot;
							$this->mobile_html .= '</a>';
							$this->mobile_html .= '</div>';
						}
					} else {
						switch($this->lang) {
							case 1: $this->mobile_html .= '<div class="calendar-notice">Please call 5405 6631 for today\'s booking</div>';
								break;
							case 2: $this->mobile_html .= '<div class="calendar-notice">請電話 5405 6631 預約</div>';
								break;
						}
					}
				} else {
					switch($this->lang) {
						case 1: $this->mobile_html .= '<div class="calendar-day-not-available">Not Available</div>';
							break;
						case 2: $this->mobile_html .= '<div class="calendar-day-not-available">没有預約</div>';
							break;
					}
				}
				$this->mobile_html .= '</div>';
			}
			$this->mobile_html .= $this->week_nav;
			$this->mobile_html .= '</div>';	
		}
		
		private function createTabletCalendar() {
			// calendar header
			$this->html = '<table id="calendar">';
			$this->html.= '<tr class="calendar-head">';
			$this->html.= '<td id="calendar-prev"><a href="'.$this->requestPreviousMonth().'">'.$this->prevMonth.'</a></td>';
			$this->html.= '<td colspan="5" id="calendar-month">'.$this->header.'</td>';
			$this->html.= '<td id="calendar-next"><a href="'.$this->requestNextMonth().'">'.$this->nextMonth.'</a></td>';
			$this->html.= '</tr>';
			
			// names of week days
			$this->html.= '<tr class="calendar-head">';
			$this->html.= '<td class="calendar-day-head">';
			$this->html.= implode('</td><td class="calendar-day-head">', $this->weedDays);
			$this->html.= '</td>';
			$this->html.= '</tr>';
			
			// days and weeks vars now ...
			$running_day = date('w',mktime(0,0,0,$this->defaultMonth,1,$this->defaultYear));
			$days_in_month = date('t',mktime(0,0,0,$this->defaultMonth,1,$this->defaultYear));
			$days_in_this_week = 1;
			$day_counter = 0;
			
			// row for week one
			$this->html.= '<tr class="calendar-row">';
			
			// print "blank" days until the first of the current week
			for($x = 0; $x < $running_day; $x++) {
				$this->html.= '<td class="calendar-day-np"> </td>';
				$days_in_this_week++;
			}
			
			// keep going with days....
			for($list_day = 1; $list_day <= $days_in_month; $list_day++) {
				$list_date = $this->defaultYear.'-'.$this->defaultMonth.'-'.str_pad($list_day, 2, '0', STR_PAD_LEFT);
	
				//get time array from myDatabase
				if($this->validDate($list_date)) {
					$timeSlots = $this->handler->get($list_date);
				}
				
				$this->html.= '<td class="calendar-day';
							
				//highlight today
				if($this->isToday($list_date)) {
					$this->html.= ' today';
				}
				
				$this->html.= '">';
				
				//add day number
				$this->html.= '<p class="day-number">';
				$this->html.= $list_day;
				$this->html.= '</p>';
				
				if($this->validDate($list_date)) {
					//add time slots
					$this->html.= '<table class="schedule">';
					$this->html.= '<tr class="schedule-row">';
					
					//time slot number
					$i = 1;
					foreach ($timeSlots as $key => $value) {
						$time = substr($value, 0, 5);
						$this->html.= '<td class="time-slot">';
						$this->html.= '<a href="booking_form.php?test='.$key.'" class="time">';
						$this->html.= $time;
						$this->html.= '</a>';
						$this->html.= '</td>';
						if(!($i % $this->timeOnRow)) {
							$this->html.= '</tr><tr class="schedule-row">';
						}
						$i++;
					}
					while($i % $this->timeOnRow) {
						$this->html.= '<td>';
						$this->html.= '</td>';
						$i++;
					}
					$this->html.= '</tr>';			
					$this->html.= '</table>';
				} elseif($this->mayPhoneBooking($list_date)) {
					//show notice
					$this->html.= 'Please call 5405 6631 for today\'s booking';			
				}
		
				//close td tag
				$this->html.= '</td>';
				
				if($running_day == 6) {
					$this->html.= '</tr>';
					if(($day_counter+1) != $days_in_month) {
						$this->html.= '<tr class="calendar-row">';
					}
					$running_day = -1;
					$days_in_this_week = 0;
				}
				$days_in_this_week++; $running_day++; $day_counter++;
			}
			
			// finish the rest of the days in the week
			if($days_in_this_week < 8) {
				for($x = 1; $x <= (8 - $days_in_this_week); $x++) {
					$this->html.= '<td class="calendar-day-np"> </td>';
				}
			}
			
			// final row
			$this->html.= '</tr>';
			
			// end the table
			$this->html.= '</table>';
			
			// all done, return result
		}
		
		private function createWebCalendar() {
			$this->web_html = '<div class="calendar">';
			$this->web_html .= $this->month_nav;
			$this->web_html .= $this->month_nav;
			$this->web_html .= '</div>';
		}
		
		private function getWeekParameters() {
			$this->week_start = clone $this->current_day;
			$this->week_start->modify("+1 day");
			$this->week_end = clone $this->week_start;
			$this->last_week = clone $this->week_start;
			$this->next_week = clone $this->week_start;
			$this->week_start->modify("monday this week");
			$this->week_start->modify("-1 day");
			$this->week_end->modify("sunday this week");
			$this->week_end->modify("-1 day");
			$this->week_number = $this->week_end->format("W"); 
			$this->last_week->modify("-8 days");
			$this->next_week->modify("+6 days");
			$this->today = new DateTime("today");
			$this->endOfTodaysBooking = clone $this->today;
			$this->endOfTodaysBooking->setTime(END_OF_BOOKING_HOUR, END_OF_BOOKING_MIN);
			$this->now = new DateTime("now");
		}
		
		private function weekNav() {
			$this->week_nav .= '<div class="week-nav">';
			$this->week_nav .= '<a href="?day=';
			$this->week_nav .= $this->last_week->format("Y-m-d"); 
			$this->week_nav .=  '">&#9664</a> ';
			$this->week_nav .= 'Week ';
			$this->week_nav .= $this->week_number;
			$this->week_nav .= ', ';
			$this->week_nav .= $this->week_start->format("F j");
			$this->week_nav .= ' - ';
			$this->week_nav .= $this->week_end->format("F j");
			$this->week_nav .= ' <a href="?day=';
			$this->week_nav .= $this->next_week->format("Y-m-d"); 			
			$this->week_nav .= '">&#9654</a>';
			$this->week_nav .= '</div>';
		}
		
		private function getMonthParameters() {
			$this->last_month = clone $this->current_day;
			$this->next_month = clone $this->current_day;
			$this->last_month->modify("last month");
			$this->next_month->modify("next month");
		}
		
		private function monthNav() {
			$this->month_nav .= '<div class="month-nav">';
			$this->month_nav .= '<a href="?day=';
			$this->month_nav .= $this->last_month->format("Y-m-d"); 
			$this->month_nav .=  '">&#9664</a> ';
			$this->month_nav .= $this->current_day->format("Y-m-d");
			$this->month_nav .= ' <a href="?day=';
			$this->month_nav .= $this->next_month->format("Y-m-d"); 			
			$this->month_nav .= '">&#9654</a>';
			$this->month_nav .= '</div>';
		}
				
		private function isToday(DateTime $date) {
			return $date == $this->today;
		}
				
		private function validDate(DateTime $date) {
			return $date >= $this->today;
		}
			
		private function allowTodayBooking() {
			return $this->now < $this->endOfTodaysBooking;
		}
		
		public function render() {
			echo $this->mobile_html;
			echo $this->web_html;
		}
		
	}
?>